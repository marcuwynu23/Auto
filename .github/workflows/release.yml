name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v2.0.3)'
        required: true
        type: string

jobs:
  setup:
    runs-on: windows-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_number: ${{ steps.version.outputs.version_number }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up environment
        id: version
        shell: pwsh
        run: |
          $version = if ($env:GITHUB_REF -like 'refs/tags/*') { 
            $env:GITHUB_REF -replace 'refs/tags/', '' 
          } else { 
            ${{ github.event.inputs.version }}
          }
          $versionNumber = $version -replace '^v', ''
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "version_number=$versionNumber" >> $env:GITHUB_OUTPUT
          echo "Version: $version"
          echo "Version Number: $versionNumber"

  build:
    runs-on: windows-latest
    needs: setup
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install LLVM
        uses: KyleMayes/install-llvm-action@v2
        with:
          version: "latest"
          cached: true

      - name: Install MinGW-w64 (for windres and make)
        shell: pwsh
        run: |
          # Install MinGW-w64 using Chocolatey
          choco install mingw -y
          
          # Add MinGW to PATH
          $mingwPath = "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin"
          if (Test-Path $mingwPath) {
            echo "$mingwPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            echo "MinGW installed at: $mingwPath"
          } else {
            # Try alternative path
            $mingwPath = "C:\tools\mingw64\bin"
            if (Test-Path $mingwPath) {
              echo "$mingwPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            }
          }
          
          # Install make separately if needed
          choco install make -y
          
          # Verify tools
          windres --version
          make --version

      - name: Verify Tools
        shell: pwsh
        run: |
          clang++ --version
          windres --version
          make --version
          echo "All tools verified successfully"

      - name: Build executable
        shell: pwsh
        run: |
          # Build using llvm.makefile
          make -f llvm.makefile all
          
          # Verify executable was created
          if (Test-Path "bin/auto.exe") {
            echo "Executable built successfully"
            Get-Item "bin/auto.exe" | Select-Object Name, Length, LastWriteTime
          } else {
            Write-Error "Failed to build executable"
            exit 1
          }

      - name: Upload executable artifact
        uses: actions/upload-artifact@v4
        with:
          name: auto-executable
          path: bin/auto.exe
          retention-days: 1

  package:
    runs-on: windows-latest
    needs: [setup, build]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download executable artifact
        uses: actions/download-artifact@v4
        with:
          name: auto-executable
          path: bin/

      - name: Install Inno Setup
        shell: pwsh
        run: |
          # Install Inno Setup using Chocolatey
          choco install innosetup -y
          
          # Verify installation
          $isccPath = "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe"
          if (-not (Test-Path $isccPath)) {
            $isccPath = "${env:ProgramFiles}\Inno Setup 6\ISCC.exe"
          }
          
          if (Test-Path $isccPath) {
            echo "Inno Setup installed successfully at: $isccPath"
            & $isccPath /?
          } else {
            Write-Error "Inno Setup installation failed"
            exit 1
          }

      - name: Update installer script version
        shell: pwsh
        run: |
          $version = "${{ needs.setup.outputs.version }}"
          $versionNumber = "${{ needs.setup.outputs.version_number }}"
          $content = Get-Content "installer-script/Auto.iss" -Raw
          
          # Update version in OutputBaseFilename
          $content = $content -replace 'OutputBaseFilename=AutoInstaller\.\d+\.\d+\.\d+', "OutputBaseFilename=AutoInstaller.$versionNumber"
          
          # Update AppVersion
          $content = $content -replace 'AppVersion=\d+\.\d+\.\d+', "AppVersion=$versionNumber"
          
          # Update paths to use relative paths
          $workspace = $env:GITHUB_WORKSPACE -replace '\\', '/'
          $content = $content -replace 'OutputDir=D:\\Projects\\marcuwynu23\\Auto\\bin', "OutputDir=$workspace/bin"
          $content = $content -replace 'Source: "D:\\Projects\\marcuwynu23\\Auto\\bin\\auto.exe"', "Source: `"$workspace/bin/auto.exe`""
          
          Set-Content -Path "installer-script/Auto.iss" -Value $content

      - name: Build MSI installer
        shell: pwsh
        run: |
          # Use ISCC from Inno Setup
          $iscc = "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe"
          if (-not (Test-Path $iscc)) {
            $iscc = "${env:ProgramFiles}\Inno Setup 6\ISCC.exe"
          }
          
          if (-not (Test-Path $iscc)) {
            Write-Error "Inno Setup compiler not found at $iscc"
            exit 1
          }
          
          & $iscc "installer-script/Auto.iss"
          
          # Verify installer was created
          $installer = Get-ChildItem -Path "bin" -Filter "AutoInstaller.*.exe" | Select-Object -First 1
          if ($installer) {
            echo "Installer built successfully: $($installer.Name)"
            $installer | Select-Object Name, Length, LastWriteTime
          } else {
            Write-Error "Failed to build installer - no matching file found in bin directory"
            Get-ChildItem -Path "bin" | Select-Object Name
            exit 1
          }

      - name: Prepare release artifacts
        shell: pwsh
        run: |
          # Create artifacts directory
          New-Item -ItemType Directory -Path "release-artifacts" -Force | Out-Null
          
          # Copy executable
          Copy-Item "bin/auto.exe" -Destination "release-artifacts/auto.exe"
          
          # Copy installer
          $installer = Get-ChildItem -Path "bin" -Filter "AutoInstaller.*.exe" | Select-Object -First 1
          if ($installer) {
            Copy-Item $installer.FullName -Destination "release-artifacts/$($installer.Name)"
          }
          
          # List artifacts
          Get-ChildItem "release-artifacts" | Select-Object Name, Length

      - name: Get installer filename
        id: installer
        shell: pwsh
        run: |
          $installer = Get-ChildItem -Path "bin" -Filter "AutoInstaller.*.exe" | Select-Object -First 1
          if ($installer) {
            echo "name=$($installer.Name)" >> $env:GITHUB_OUTPUT
            echo "path=release-artifacts/$($installer.Name)" >> $env:GITHUB_OUTPUT
          } else {
            Write-Error "Installer file not found"
            exit 1
          }

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: release-artifacts/*
          retention-days: 1

  release:
    runs-on: windows-latest
    needs: [setup, package]
    permissions:
      contents: write
    
    steps:
      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: release-artifacts/

      - name: Get installer filename
        id: installer
        shell: pwsh
        run: |
          $installer = Get-ChildItem -Path "release-artifacts" -Filter "AutoInstaller.*.exe" | Select-Object -First 1
          if ($installer) {
            echo "name=$($installer.Name)" >> $env:GITHUB_OUTPUT
            echo "path=release-artifacts/$($installer.Name)" >> $env:GITHUB_OUTPUT
          } else {
            Write-Error "Installer file not found"
            exit 1
          }

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release-artifacts/auto.exe
            ${{ steps.installer.outputs.path }}
          tag_name: ${{ needs.setup.outputs.version }}
          name: Release ${{ needs.setup.outputs.version }}
          body: |
            ## Release ${{ needs.setup.outputs.version }}
            
            ### Downloads
            - **auto.exe** - Standalone executable
            - **${{ steps.installer.outputs.name }}** - Windows installer
            
            ### Installation
            1. Download the installer for automatic installation
            2. Or download auto.exe and add it to your PATH manually
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
