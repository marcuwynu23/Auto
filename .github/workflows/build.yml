name: Build C++ Executable with LLVM

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup LLVM
        uses: egor-tensin/setup-llvm@v1
        with:
          version: latest
          platform: x64
          components: clang, lld

      - name: Install MinGW-w64 (for windres and make)
        uses: egor-tensin/setup-mingw@v2
        with:
          platform: x64
          version: latest
          components: mingw-w64-x86_64-binutils, mingw-w64-x86_64-make

      - name: Verify Tools
        shell: pwsh
        run: |
          clang++ --version
          windres --version
          make --version
          echo "All tools verified successfully"

      - name: Build Executable
        shell: pwsh
        run: |
          make -f llvm.makefile all
          
          # Verify executable was created
          if (Test-Path "bin/auto.exe") {
            echo "Build successful!"
            Get-Item "bin/auto.exe" | Select-Object Name, Length, LastWriteTime
          } else {
            Write-Error "Build failed - executable not found"
            exit 1
          }

      - name: Run Executable
        shell: pwsh
        run: |
          make -f llvm.makefile run

      - name: Clean Build Artifacts
        shell: pwsh
        run: |
          make -f llvm.makefile clean
