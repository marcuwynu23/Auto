name: Build C++ Executable with LLVM

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install LLVM
        uses: KyleMayes/install-llvm-action@v2
        with:
          version: "latest"
          cached: true

      - name: Install MinGW-w64 (for windres and make)
        shell: pwsh
        run: |
          # Install MinGW-w64 using Chocolatey
          choco install mingw -y
          
          # Add MinGW to PATH
          $mingwPath = "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin"
          if (Test-Path $mingwPath) {
            echo "$mingwPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            echo "MinGW installed at: $mingwPath"
          } else {
            # Try alternative path
            $mingwPath = "C:\tools\mingw64\bin"
            if (Test-Path $mingwPath) {
              echo "$mingwPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            }
          }
          
          # Install make separately if needed
          choco install make -y
          
          # Verify tools
          windres --version
          make --version

      - name: Verify Tools
        shell: pwsh
        run: |
          clang++ --version
          windres --version
          make --version
          echo "All tools verified successfully"

      - name: Build Executable
        shell: pwsh
        run: |
          make -f llvm.makefile all
          
          # Verify executable was created
          if (Test-Path "bin/auto.exe") {
            echo "Build successful!"
            Get-Item "bin/auto.exe" | Select-Object Name, Length, LastWriteTime
          } else {
            Write-Error "Build failed - executable not found"
            exit 1
          }

      - name: Run Executable
        shell: pwsh
        run: |
          make -f llvm.makefile run

      - name: Clean Build Artifacts
        shell: pwsh
        run: |
          make -f llvm.makefile clean
